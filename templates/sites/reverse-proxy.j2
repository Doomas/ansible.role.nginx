##
# File:        roles/nginx/templates/sites/revers-proxy.j2
# Author:      Thomas Galliker
# Author mail: mail@thomasgalliker.net
# Created:     12.08.2017
# Description: Nginx configuration generated by Ansible. Do not modify it
#              directly use Ansible for Updates.
##

server {
        # Server
        listen 80;
        server_name {{ item.url }};

{% if item.ssl is defined %}
        # Redirct to SSL
        rewrite ^ https://$server_name$request_uri? permanent;
{% else %}
        location / {
                proxy_pass {{ item.proxy.url }};

                # Set headers
                proxy_set_header        Accept-Encoding "";
                proxy_set_header        Host            $host;
                proxy_set_header        X-Real-IP       $remote_addr;
                proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_set_header        X-Forwarded-Proto $scheme;
                add_header              Front-End-Https ond;

                proxy_redirect default;
        }
{% endif %}
}

{% if item.ssl is defined %}
server {
        # Basic server settings
        listen                  {{ item.ssl.port | default(443) }};
        ssl                     on;
        server_name             {{ item.url }};


        # SSL log files
        access_log		/var/log/nginx/{{ item.url }}.ssl.access.log;
        error_log		/var/log/nginx/{{ item.url }}.ssl.error.log;

        # SSL certificate files
        ssl_certificate         {{ item.ssl.certificate }};
        ssl_certificate_key     {{ item.ssl.certificate_key }};

        # SSL settings
        ssl_protocols           TLSv1 TLSv1.1 TLSv1.2;
#       ssl_ciphers             RC4:HIGH:!aNULL:!MD5;
        ssl_ciphers             ECDHE-RSA-AES128-SHA256:AES128-GCM-SHA256:RC4:HIGH:MEDIUM:!aNULL:!MD5:!ADH:!eNULL:!LOW:!EXP;
        ssl_prefer_server_ciphers on;
        keepalive_timeout       60;
        ssl_session_cache       shared:SSL:10m;
        ssl_session_timeout     10m;

	client_max_body_size	512m;


        location / {
                proxy_pass {{ item.proxy.url }};

                # Set headers
                proxy_set_header        Accept-Encoding "";
                proxy_set_header        Host            $host;
                proxy_set_header        X-Real-IP       $remote_addr;
                proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_set_header        X-Forwarded-Proto $scheme;
                add_header              Front-End-Https ond;

                proxy_redirect default;
        }
}
{% endif %}
